import BlogPost from '../../../components/BlogPost';

export const meta = {
  id: 0,
  title: 'Creando una API GraphQL con Apollo Server Lambda y Netlify',
  description: 'Construir una API GraphQL con Apollo es realmente muy sencillo. Obviamente que esto depende del tama√±o de nuestra API. Hace unos d√≠as empeze a desarrollar una API GraphQL con Apollo Server Lambda y Netlify Lambda....',
  date: 'Oct. 20, 2020',
  readTime: 4,
  postBy: 'https://twitter.com/franqsanz'
}

export default ({ children }) => <BlogPost meta={meta}>{children}</BlogPost>;

Construir una API GraphQL con Apollo es realmente muy sencillo. Obviamente que esto depende del tama√±o de nuestra API.

Hace unos d√≠as empeze a desarrollar una API GraphQL con Apollo Server Lambda y Netlify Lambda y quer√≠a compartir con ustedes lo sencillo que fue construirla.
Aunque estuve con un poco de dolor de cabeza al momento de desplegar la API jajaja pero creo esto es normal ¬øno?.

## Manos a la obra üë∑‚Äç‚ôÇÔ∏è
Lo primero que debemos hacer es obviamente instalar nuestras dependencias para el proyecto.

Instalar las siguientes dependencias:

* apollo-server-lambda

* graphql

* netlify-lambda

* encoding

Una vez que tengamos nuestras dependencias instaladas abrimos el `package.json` y en el campo `scripts` colocamos lo siguiente:

```JSON
"scripts": {
  "start": "netlify-lambda serve src",
  "build": "netlify-lambda build src"
}
```

El `src` hace referencia al nombre de la carpeta que contendr√° nuestros archivos (puede tener cualquier otro nombre), en este caso yo decid√≠ por `src`.

Ahora creemos un archivo `js` con el nombre graphql y requerimos ApolloServer.

Un ejemplo a continuaci√≥n.

```JS
const { ApolloServer } = require('apollo-server-lambda');

const server = new ApolloServer({});

exports.handler = server.createHandler();
```
Ahora podemos ejecutar nuestra api
```SH
$ npm start

# o con yarn
$ yarn start
```

Una vez ejecutada la API vamos al navegador y en la URL pasamos `localhost:9000/graphql` y nos mostrar√° el GraphQL Playground, pero a√∫n no podremos hacer consultas ya que no hemos agregado un esquema y no hay datos.

Ejemplo de como se ve el playground:

![playground](/playground.png)

## Creando los esquemas o typeDefs
En una API GraphQL necesitamos crear esquemas o tambi√©n llamados definici√≥n de tipos, es como validar la API o tambien puede ser considerado como un mapa de lo que recibiremos.

Creamos un nuevo archivo.

```JS
const { gql } = require('apollo-server-lambda');

const typeDefs = gql`
  type users {
    id: ID
    username: String
    name: String
    lastname: String
    age: Int
  }

  type Query {
    Users: [users]
  }
`;

module.exports = typeDefs;
```

Una vez que tengamos nuestros typeDefs es hora de pedir los datos respetando este esquema.

## Creando los resolvers
En GraphQL existen los `resolvers`, que son los que resolver√°n nuestro `typeDefs`, osea son los encargados de traer los datos respetando los `typeDefs`.

Creamos un nuevo archivo.

```JS
// Ejemplo si los datos estar√≠an en un archivo est√°tico.
const users = require('./data');

const resolvers = {
  Query: {
   Users: () => users
  }
};

module.exports = resolvers;
```

Aqu√≠ es donde nosotros har√≠amos las consultas a la base de datos o a√∫n archivo est√°tico. Una vez que tengamos los `typeDefs` y `resolvers` listos, tenemos que pasarlos a la configuraci√≥n del server.

Volvemos al archivo graphql

```JS
const { ApolloServer } = require('apollo-server-lambda');
const typeDefs = require('./typeDefs');
const resolvers = require('./resolvers');

const server = new ApolloServer({
  typeDefs,
  resolvers
});

exports.handler = server.createHandler();
```

ApolloServer es un objeto y se pueden pasar muchas m√°s opciones pero como m√≠nimo debe tener estos dos.
Ahora si volvemos a ejecutar nuestra API esta vez podremos hacer consultas en el playground.

Ejemplo:

```GraphQL
query allUsers {
  Users {
   id
   username
   name
   lastname
   age
 }
}
```
Respuesta:
```JSON
{
 "data": {
  "Users": [
    {
      "id": "1",
      "username": "Franqsanz",
      "name": "Franco Andr√©s",
      "lastname": "S√°nchez",
      "age": 23
    },
    //...
  ]
 }
}
```
Ahora que tenemos nuestra API lista podemos desplegar a Netlify pero primero necesitamos un archivo llamado `netlify.toml` que contendr√° la configuraci√≥n para Netlify.
Este archivo debe ir en la ra√≠z del proyecto.

Ejemplo de como se ve un archivo `netlify.toml`:

```TOML
[build]
  command = "npm run build" # o con yarn: "yarn build".
  functions = "functions" # este comando crear√° una carpeta llamada "functions" y guardara las funciones Lambda.
  publish = "src" # carpeta que contiene los archivos del proyecto.

[[redirects]]
  from = "/graphql"
  to = "./netlify/functions/graphql"
  status = 200
  force = true
```
El comando `functions` crear√° una carpeta con el nombre que nosotros le demos en este caso yo decid√≠ llamarlo `functions`, pero puede ser `lambda` por ejemplo. Tu no tienes que preocuparte por esta carpeta, se crear√° autom√°ticamente cuando ejecutes el proyecto.
Esta son las funciones Lambda, pero no voy a profundizar en el tema por qu√© no tengo mucho conocimiento a√∫n.

## Desplegando a Netlify üöÄ
Una vez que tengamos todo listo es hora de desplegar la API, primero creamos un repositorio en github para as√≠ tener despliegue continuo a Netlify, luego crearse una cuenta en Netlify o si ya tienes una inicia sesi√≥n, ahora solo debes agregar este repositorio a Netlify y esperar que se implemente.

Si te haz dado cuenta hay una dependencia que no hemos usado `encoding` est√° dependencia lo usar√° Netlify, por lo menos en m√≠ caso deb√≠ instalarla ya que me daba un error al momento del despliegue.

Si todo sali√≥ bien ya podr√°s ver tu API en producci√≥n con el CDN generado y probar c√≥mo funciona.

## Conclusi√≥n
Este fue una breve introducci√≥n de como crear una API GraphQL y desplegar en Netlify con funciones Lambda, hay mucho m√°s por aprender y hay muy buenos art√≠culos en internet. Espero que te haya sido √∫til este art√≠culo.

Puedes ver m√≠ API en github por si tienes dudas.

[Ver API en GitHub](https://github.com/Franqsanz/fruits-api)

[Ver API en producci√≥n](https://fruits-api.netlify.app/graphql)

Puedes forquear o clonar el repositorio y mejorarlo. üëçüèª

Si llegaste hasta aqu√≠ wow muchas gracias por leer!!! üíõ

Me puedes encontrar en [Twitter](https://twitter.com/franqsanz).

üìù[Edit post on GitHub](https://github.com/Franqsanz/GDevTown/blob/main/pages/blog/creando-una-api-graphql-con-apollo-server-lambda-y-netlify/index.mdx)